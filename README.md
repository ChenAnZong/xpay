## :moneybag:  微信/支付宝个人收款

微信/支付宝监控个人收款，无需签约支付宝、微信支付。为支付宝、微信支付的个人账户提供即时到账服务  

#### :speech_balloon: xposed   

使用 xposed 监控收款通知，需要安装[xposed](http://repo.xposed.info/)监控通知。手机的设置很重要，需要把各种权限打开，让你要监控的目标把通知打开，判断标准就是，听到语音播报就可以 。  
###### 安装  
 xposed必要安装在已Root的手机或者免 Root的virtualxposed的双开系统中安装。  
###### 原理  

xposed监控到支付宝到账100元，会把该监控到的通知信息推送给Xpay支付系统，推送消息的大体内容如下

```
{
  'type' => 'alipay',
  'no' => '20180920200040011100060068897740',
  'version' => '1',
  'userids' => '917104708653',
  'token' => 'f75xbeHB+nblekV...AiyPt+eu0SOpGn6o=',
  'money' => '0.01',
  'mark' => 'T356180917104708653',
  'dt' => '1537408518027',
  'account' => 'tinywan@tinywan.com',
  'sign' => '74d6446c9298bcba3455e5dab056e3a9',
}
```
> 1、验证请求字段的正确性 ，消息类型（转账）、支付类型（微信/支付宝）
>
> 2、验证token（RSA加密/解密）有效性。判断当前token的APP是否登录
>
> 3、根据商户ID（userids）、支付预定单号（mark）、订单金额（money）、未支付订单（status = 0）查询是否有该预订单生成 
>
> 4、否，直接返回给APP相应的错误信息。是，直接处理该订单信息，返回给APP成功信息  

#### :speech_balloon: 预支付二维码生成   

###### 环境配置  

配置ngrok本地代理  

###### 固定金额  

通过请求接口返回的金额，生成固定金额的预支付二维码（预设数量进行生成，eg：10）。通过隧道连接 Xpay APP，调用支付宝/微信生成预支付二维码。把预支付二维码的链接地址以及预生成订单号同步返回给Xpay支付系统保存在数据库中。这时候该预支付二维码就会和商户、收款账户以及其他信息帮困在一起了。  

###### 阶梯金额   

生成该金额，必须的现在商户后台配置，金额与生成数量。然后根据收款账户批量生成对应的预支付二维码，为了使预支付二维码能后多次时候，该预支付二维码会在生成订单的同时增加一个预支付二维码的过期时间（如：7分钟之后，该订单将会自动失效或者不可以进行再次支付了），  

#### :speech_balloon: 收款码金额识别  

二维码的金额需要入数据库才可以在用户订单选择5元的时候,展示5.01元的收款码,如果让客户一张张的手动输入金额.那还用程序员干啥?  
微信支付宝的收款码金额识别:
框架是没有.但是收费API有.可以把收款码上传给API,阿里云/腾讯云/百度云 都有文字识别API.腾讯云一天1000是免费的.可以用.  
这里使用的是腾讯云的OCR,识别二维码的收款金额;调用API即可获取二维码上的所有文字.找到￥符号.正则匹配即可.

#### :speech_balloon: 补单  

不怕一万就怕万一.如果哪个订单收到钱而未触发订单完成.那么就需要手动完成一下订单咯.(比如关机,断网,都有可能导致)  
订单管理,列出了自己的所有订单.看看有没有失败的订单(收到钱,没发货).手动点一下完成即可  